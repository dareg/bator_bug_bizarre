SUBROUTINE COMPACT(PVALCO_COMPACT,KNELEM,KBITEXPONENT,KBITRADICAL,KPACK)

USE PARKIND1 , ONLY : JPRB
USE YOMHOOK  , ONLY : LHOOK, DR_HOOK

IMPLICIT NONE

INTEGER(KIND=4) :: KNELEM
REAL(KIND=8) :: PVALCO_COMPACT(KNELEM)
REAL(KIND=8) :: ZCOEF,VALMIN,VALMAX
INTEGER(KIND=4) :: KBITEXPONENT,KBITRADICAL
INTEGER(KIND=8) :: KPACK(KNELEM)

REAL(KIND=4) :: ZTMPBUF
INTEGER(KIND=4) :: ITMPBUF
INTEGER(KIND=8) :: ICMPBUF,ILENGTH
INTEGER(KIND=4),ALLOCATABLE :: IBUF(:)
INTEGER(KIND=4) :: IPROMA,IPTRTAB,IPTRBIT,IENDBIT,I4B0,I4B1
INTEGER(KIND=2) :: I2B0,I2B1,I2B2,I2B3

REAL(KIND=JPRB) :: ZHOOK_HANDLE

EQUIVALENCE(ZTMPBUF,ITMPBUF)

IF (LHOOK) CALL DR_HOOK('COMPACT',0,ZHOOK_HANDLE)

!SOLUTION 1 CA MARCHE MAIS CA COMPRESSE PAS TELLEMENT
!DO IPROMA=1,KNELEM
!   ZTMPBUF=PVALCO_COMPACT(IPROMA)
!   KPACK(IPROMA)=ITMPBUF
!END DO

!SOLUTION 2
KPACK=0
VALMIN=MINVAL(PVALCO_COMPACT(1:KNELEM))
ZTMPBUF=VALMIN
I4B0=ITMPBUF
VALMAX=MAXVAL(PVALCO_COMPACT(1:KNELEM))
ZTMPBUF=VALMAX
ICMPBUF=ITMPBUF
KPACK(1)=ISHFT(ICMPBUF,32)
KPACK(1)=KPACK(1)+I4B0
ILENGTH=1
ZCOEF=(2**KBITRADICAL-1)
IPTRBIT=0
IPTRTAB=2
IF (VALMAX-VALMIN<=0.0) THEN
!WRITE(6,*) 'DEBUG COMPACT VALMAX-VALMIN inf zero'
!WRITE(6,*) 'DEBUG COMPACT',VALMAX,VALMIN
!WRITE(6,*) 'DEBUG COMPACT',PVALCO_COMPACT(1:10)
!CALL ABORT('DIVISION PAR ZERO')
KNELEM=1
ELSE

DO IPROMA=1,KNELEM
ICMPBUF=(PVALCO_COMPACT(IPROMA)-VALMIN)/(VALMAX-VALMIN)*ZCOEF
!PRINT*, ICMPBUF
!WRITE(*,"32I1") (IBITS(ICMPBUF,II,1),II=0,63)

IF (IPTRBIT+KBITRADICAL<64) THEN
KPACK(IPTRTAB)=KPACK(IPTRTAB)+ISHFT(IBITS(ICMPBUF,0,KBITRADICAL),IPTRBIT)
IPTRBIT=IPTRBIT+KBITRADICAL
ELSE
IENDBIT=64-IPTRBIT
KPACK(IPTRTAB)=KPACK(IPTRTAB)+ISHFT(IBITS(ICMPBUF,0,IENDBIT),IPTRBIT)
IPTRTAB=IPTRTAB+1
IPTRBIT=0
KPACK(IPTRTAB)=IBITS(ICMPBUF,IENDBIT,KBITRADICAL-IENDBIT)
IPTRBIT=KBITRADICAL-IENDBIT
END IF
END DO
!WRITE(*,"32I1") (IBITS(KPACK(2),II,1),II=0,63)
KNELEM=IPTRTAB+1
END IF

!SOLUTION 3 CA MARCHE PAS BIEN
!ALLOCATE(IBUF(KNELEM))
!IBUF=0

!DO IPROMA=1,KNELEM
!   ZTMPBUF=PVALCO_COMPACT(IPROMA)
!   IBUF(IPROMA)=IBITS(ITMPBUF,23-KBITRADICAL,KBITRADICAL)&
!        &+ISHFT(IBITS(ITMPBUF,23,KBITEXPONENT),KBITRADICAL)&
!        &+ISHFT(IBITS(ITMPBUF,30,2),KBITRADICAL+KBITEXPONENT)
!END DO

!WRITE(6,*) 'DEBUG COMPACT',IBUF(1)

!IPTRBIT=0
!IPTRTAB=1
!KPACK=0
!DO IPROMA=1,KNELEM
!!WRITE(6,*) 'DEBUG COMAPCT 4',IPROMA
!!CALL FLUSH(6)
!   IF (IPTRBIT+KBITRADICAL+2+KBITEXPONENT<64) THEN
!      ICMPBUF=IBUF(IPROMA)
!      KPACK(IPTRTAB)=KPACK(IPTRTAB)+ISHFT(IBITS(ICMPBUF,0,KBITRADICAL+2+KBITEXPONENT),(IPTRBIT))
!      IPTRBIT=IPTRBIT+KBITRADICAL+2+KBITEXPONENT
!      
!   ELSE
!      IENDBIT=64-IPTRBIT
!      ICMPBUF=IBUF(IPROMA)
      
!      KPACK(IPTRTAB)=KPACK(IPTRTAB)+ISHFT(IBITS(ICMPBUF,0,IENDBIT),(IPTRBIT))
!      IPTRBIT=0
!      IPTRTAB=IPTRTAB+1
!      KPACK(IPTRTAB)=IBITS(ICMPBUF,IENDBIT,KBITRADICAL+2+KBITEXPONENT-IENDBIT)
!      IPTRBIT=IPTRBIT+KBITRADICAL+2+KBITEXPONENT-IENDBIT
!   END IF
!   KNELEM=IPTRTAB
!END DO

IF (LHOOK) CALL DR_HOOK('COMPACT',1,ZHOOK_HANDLE)

END SUBROUTINE COMPACT
