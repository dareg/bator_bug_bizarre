#-------------------------------------------------------#
#    makefile for L2B_bufr2odb                          #
#                                                       #
#    Written by:  Jos de Kloe                           #
#    created:     02-Nov-2011                           #
#    last change: 30-07-2015                            #
#                 Modified for L2B_bufr2odb             #
#                 by M Rennie                           #
#-------------------------------------------------------#

# General settings and compiler options
include  ../Makeoptions

# include a little file defining which support objects to use
include ../support/Objects.txt

# include the ee_cfi library in case we wish to use it
# this defines the LIBS_DIR and LIBS variables
include ../library_definition

# Definition of the objects for the odb2 module
include ../ODB2_file_handling/Objects_odb2.txt

# include the dependency to the support and other modules 
# in the compiler options

# needed to create ODB-2 files, ECMWF local settings, make sure up-to-date
ODBFLAGS1  = ${ODB_FORTRAN_INCLUDE}
ODBFLAGS2  = ${ODB_FORTRAN_LIB}
#ecCodes needed to read the BUFR file
ECCODES    = ${ECCODES_INCLUDE} ${ECCODES_LIB} 

MYF90FLAGS  = ${ECCODES}   \
              $(ODBFLAGS1) \
              $(ODBFLAGS2) \
              $(MODINCFLAG)$(DEP_SUPPORT) \
              $(MODINCFLAG)$(DEP_ODB2_FILE_HANDLING)

MYLINKFLAGS = $(MYF90FLAGS)

# executables to be made by this script
EXECUTABLE1  = L2B_bufr2odb

# objects needed by the executables
DEP_OBJECTS1 = $(OBJECTS_SUPPORT) \
               $(OBJECTS_ODB2_FILE_HANDLING)

OBJECTS1 = $(DEP_OBJECTS1) l2b_bufr_and_odb.o

# make all test programs when make is used without options
all: $(EXECUTABLE1)

# link the first executable
$(EXECUTABLE1): $(EXECUTABLE1).o $(OBJECTS1)
	@echo linking the program
	$(LINK) $(LINKFLAGS) $(MYLINKFLAGS) -o $(EXECUTABLE1) \
                $(EXECUTABLE1).o $(OBJECTS1) $(LIBS_DIR) $(LIBS)

# make all needed object files
$(EXECUTABLE1).o: $(EXECUTABLE1).F90 $(OBJECTS1)

L2B_bufr2odb.o: L2B_bufr2odb.F90 $(DEP_OBJECTS1)

$(OBJECTS_SUPPORT):
	cd $(DEP_SUPPORT); $(MAKE) -f Makefile.aeolus

#--------------------------------------------------------------------
# generate the Makeoptions include file, in case it is not yet present
#--------------------------------------------------------------------
../Makeoptions:
	cd ..; ./Set_Makeoptions.sc

#--------------------------------------------------------------------
# some code to clean up and build again
#--------------------------------------------------------------------
.PHONY : again
again:
	$(MAKE) -f Makefile.aeolus clean; $(MAKE) -f Makefile.aeolus

#--------------------------------------------------------------------
# some code to clean up 
#--------------------------------------------------------------------
.PHONY : clean
clean:
	$(RM) $(RMFLAGS) *.mod
	$(RM) $(RMFLAGS) *.o
	$(RM) $(RMFLAGS) *~
	$(RM) $(RMFLAGS) $(EXECUTABLE1)
#--------------------------------------------------------------------

